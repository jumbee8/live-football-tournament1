<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="UTF-8">
<title>Focitorna Admin</title>
<style>
body { font-family: Arial; background: #eee; }
.box { max-width: 1000px; margin: auto; background: white; padding: 20px; border-radius: 10px; }
input, button, select { padding: 6px; margin: 5px; }
.groupBox { border:1px solid #ccc; padding:10px; margin:5px; border-radius:8px; background:#f8f8f8; }
.matchBox { border-bottom:1px solid #ddd; padding:5px; }
.teamBox { margin:3px 0; }
</style>
</head>
<body>

<div class="box">
<h1>Admin fel√ºlet</h1>

<div id="loginSection">
<h3>Bejelentkez√©s</h3>
<input id="login_user" placeholder="Felhaszn√°l√≥n√©v"><br>
<input id="login_pass" type="password" placeholder="Jelsz√≥"><br>
<button onclick="handleLogin()">Bel√©p√©s</button>

<h3>Regisztr√°ci√≥</h3>
<input id="reg_user" placeholder="√öj felhaszn√°l√≥"><br>
<input id="reg_pass" type="password" placeholder="√öj jelsz√≥"><br>
<button onclick="handleRegister()">Regisztr√°ci√≥</button>
</div>

<div id="adminPanel" style="display:none;">
<button onclick="logout()">Kijelentkez√©s</button>

<h2>Torn√°k kezel√©se</h2>
<input id="tournamentName" placeholder="Torna neve">
<button onclick="addTournament(document.getElementById('tournamentName').value)">Torna l√©trehoz√°sa</button>
<div id="tournamentList"></div>

<h2>Csapatok felvitele</h2>
<input id="teamName" placeholder="Csapat neve">
<button onclick="addTeam()">Hozz√°ad√°s</button>
<div id="teamList"></div>

<h2>Csoportok kezel√©se</h2>
<button onclick="addManualGroup()">‚ûï √öj csoport</button>
<div id="manualGroups"></div>

<h2>M√©rk≈ëz√©sek</h2>
<div id="matchList"></div>

<h2>Kies√©ses szakasz</h2>
<input id="advanceCount" type="number" placeholder="H√°ny jut tov√°bb a csoportb√≥l">
<button onclick="generateKnockouts()">Kies√©ses szakasz gener√°l√°sa</button>
<div id="knockoutDisplay"></div>

<h2>Dobog√≥</h2>
<div id="finalPodium"></div>

<button onclick="window.location='index.html'">Eredm√©nyek megtekint√©se</button>
</div>

<script src="login.js"></script>
<script src="data.js"></script>

<script>
// --- ADMIN VIEW
function updateAdminView() {
    if(getLoggedInUser()){
        loginSection.style.display="none";
        adminPanel.style.display="block";
        renderTournamentList();
        renderTeamList();
        renderManualGroups();
        renderMatches();
    }
}
updateAdminView();

// --- LOGIN
function handleRegister(){
    let r = registerUser(reg_user.value, reg_pass.value);
    alert(r==="OK"?"Sikeres regisztr√°ci√≥!":r);
}
function handleLogin(){
    let r = loginUser(login_user.value, login_pass.value);
    if(r==="OK") updateAdminView();
    else alert(r);
}
function logout(){ logoutUser(); location.reload(); }

// --- CSAPATOK
function addTeam(){
    if(!activeTID) return alert("V√°lassz torn√°t!");
    let name = document.getElementById("teamName").value.trim();
    if(!name) return;
    let t = db.tournaments.find(x=>x.id===activeTID);
    if(t.teams.includes(name)) return alert("Ez a csapat m√°r l√©tezik!");
    t.teams.push(name); saveDB();
    renderTeamList(); renderManualGroups(); generateGroupMatches(); renderMatches();
}
function removeTeamFromGroup(g,team){
    let t=db.tournaments.find(x=>x.id===activeTID);
    t.groups[g]=t.groups[g].filter(x=>x!==team);
    saveDB(); renderManualGroups(); generateGroupMatches(); renderMatches();
}
function moveTeamToGroup(fromG,toG,team){
    let t=db.tournaments.find(x=>x.id===activeTID);
    t.groups[fromG]=t.groups[fromG].filter(x=>x!==team);
    t.groups[toG].push(team);
    saveDB(); renderManualGroups(); generateGroupMatches(); renderMatches();
}

// --- CSOPORTOK
function addManualGroup(){
    if(!activeTID) return;
    let t=db.tournaments.find(x=>x.id===activeTID);
    let i=Object.keys(t.groups).length+1;
    t.groups["Csoport "+i]=[];
    saveDB();
    renderManualGroups();
}

function renderManualGroups(){
    if(!activeTID) return;
    let t=db.tournaments.find(x=>x.id===activeTID);
    let out="";
    Object.keys(t.groups).forEach(g=>{
        out+=`<div class="groupBox"><b>${g}</b> `;
        t.groups[g].forEach(team=>{
            out+=`<div class="teamBox">${team} 
            <select id="sel_${g}_${team}">`+
                Object.keys(t.groups).filter(x=>x!==g).map(x=>`<option>${x}</option>`).join("")+
                `</select>
            <button onclick="moveTeamToGroup('${g}',document.getElementById('sel_${g}_${team}').value,'${team}')">‚¨Ö √Åthelyez</button>
            <button onclick="removeTeamFromGroup('${g}','${team}')">‚ùå</button>
            </div>`;
        });
        out+=`</div>`;
    });
    manualGroups.innerHTML=out;
}

// --- M√âRK≈êZ√âSEK
function generateGroupMatches(){
    if(!activeTID) return;
    let t=db.tournaments.find(x=>x.id===activeTID);
    t.matches=[];
    for(let g in t.groups){
        let teams=t.groups[g];
        for(let i=0;i<teams.length;i++){
            for(let j=i+1;j<teams.length;j++){
                t.matches.push({group:g,home:teams[i],away:teams[j],homeScore:null,awayScore:null});
            }
        }
    }
    saveDB(); renderMatches();
}

function renderMatches(){
    if(!activeTID) return;
    let t=db.tournaments.find(x=>x.id===activeTID);
    let out="";
    t.matches.forEach((m,i)=>{
        out+=`<div class="matchBox">
        <b>${m.group}</b> ${m.home} vs ${m.away}<br>
        <input type="number" id="h${i}" value="${m.homeScore??""}" onchange="setScore(${i})">
        -
        <input type="number" id="a${i}" value="${m.awayScore??""}" onchange="setScore(${i})">
        </div>`;
    });
    matchList.innerHTML=out;
}

function setScore(idx){
    let t=db.tournaments.find(x=>x.id===activeTID);
    t.matches[idx].homeScore=Number(document.getElementById("h"+idx).value);
    t.matches[idx].awayScore=Number(document.getElementById("a"+idx).value);
    saveDB();
}

// --- KIES√âS
function generateKnockouts(){
    if(!activeTID) return;
    let t=db.tournaments.find(x=>x.id===activeTID);
    let adv=Number(advanceCount.value);
    if(!adv) return alert("√çrd be a tov√°bbjut√≥k sz√°m√°t!");
    let qualified=[];
    for(let g in t.groups){
        let teams=t.groups[g]; let scores={}; teams.forEach(x=>scores[x]=0);
        t.matches.filter(m=>m.group===g).forEach(m=>{
            if(m.homeScore!=null && m.awayScore!=null){
                if(m.homeScore>m.awayScore) scores[m.home]+=3;
                else if(m.homeScore<m.awayScore) scores[m.away]+=3;
                else { scores[m.home]++; scores[m.away]++; }
            }
        });
        let sorted = Object.keys(scores).sort((a,b)=>scores[b]-scores[a]);
        qualified.push(...sorted.slice(0,adv));
    }
    t.knockout=[]; while(qualified.length>=2){
        let a=qualified.shift(); let b=qualified.pop();
        t.knockout.push({home:a,away:b,homeScore:null,awayScore:null});
    }
    saveDB(); renderKnockout();
}

function renderKnockout(){
    if(!activeTID) return;
    let t=db.tournaments.find(x=>x.id===activeTID);
    knockoutDisplay.innerHTML=t.knockout.map((m,i)=>`
        <div class="matchBox">
        ${m.home} vs ${m.away}<br>
        <input id="kh${i}" type="number" value="${m.homeScore??""}" onchange="setKnockScore(${i})">
        -
        <input id="ka${i}" type="number" value="${m.awayScore??""}" onchange="setKnockScore(${i})">
        </div>`).join("");
}

function setKnockScore(idx){
    let t=db.tournaments.find(x=>x.id===activeTID);
    t.knockout[idx].homeScore=Number(document.getElementById("kh"+idx).value);
    t.knockout[idx].awayScore=Number(document.getElementById("ka"+idx).value);
    saveDB();
}

// --- DOB√ìG√ì (egyszer≈±)
function computePodium(){
    let t=db.tournaments.find(x=>x.id===activeTID);
    if(!t.knockout.length) return;
    let f=t.knockout[t.knockout.length-1];
    let champ=f.homeScore>f.awayScore?f.home:f.away;
    let second=champ===f.home?f.away:f.home;
    t.podium=[champ,second,"3. hely ‚Äì nincs kisorsolva"];
    saveDB();
    finalPodium.innerHTML=`ü•á ${t.podium[0]}<br>ü•à ${t.podium[1]}<br>ü•â ${t.podium[2]}`;
}
</script>

</body>
</html>
