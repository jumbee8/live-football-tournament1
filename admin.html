<!DOCTYPE html>
<html lang="hu">
<head>
<meta charset="utf-8" />
<title>Focitorna ‚Äî Admin</title>
<meta name="viewport" content="width=device-width,initial-scale=1" />
<style>
body{font-family:Arial,Helvetica,sans-serif;background:#f0f2f5;color:#111;padding:12px;}
.container{max-width:1100px;margin:10px auto;background:#fff;padding:18px;border-radius:8px;box-shadow:0 2px 8px rgba(0,0,0,0.06);}
.row{display:flex;gap:12px;align-items:center;flex-wrap:wrap;margin-bottom:10px;}
.col{flex:1;min-width:220px;}
.box{border:1px solid #e3e6ea;padding:10px;border-radius:6px;background:#fafafa;}
h1,h2{margin:6px 0;}
button{padding:6px 10px;border-radius:6px;border:1px solid #bbb;background:#fff;cursor:pointer;}
input,select{padding:6px;border:1px solid #ccc;border-radius:6px;width:100%;}
.small{width:120px;}
.groupBox{border:1px solid #ddd;padding:8px;margin:8px 0;border-radius:6px;background:#fff;}
.teamItem{display:flex;align-items:center;gap:8px;justify-content:space-between;padding:6px 8px;border-radius:6px;background:#f7f9fc;margin:4px 0;}
.matchRow{display:flex;gap:8px;align-items:center;flex-wrap:wrap;padding:6px;border-bottom:1px solid #eee;}
.bad{color:#9b1111;font-weight:bold;}
.success{color:#117a37;font-weight:bold;}
</style>
</head>
<body>
<div class="container">
  <h1>Focitorna ‚Äî Admin</h1>

  <!-- LOGIN / REGISTER -->
  <div id="authArea" class="box">
    <div class="row">
      <div class="col">
        <h3>Regisztr√°ci√≥</h3>
        <input id="regUser" placeholder="Felhaszn√°l√≥n√©v">
        <input id="regPass" placeholder="Jelsz√≥" type="password">
        <button onclick="uiRegister()">Regisztr√°l√°s</button>
      </div>
      <div class="col">
        <h3>Bejelentkez√©s</h3>
        <input id="logUser" placeholder="Felhaszn√°l√≥n√©v">
        <input id="logPass" placeholder="Jelsz√≥" type="password">
        <button onclick="uiLogin()">Bel√©p√©s</button>
      </div>
      <div class="col" style="min-width:200px">
        <h3>Jelenleg</h3>
        <div id="who">Nincs bejelentkezve</div>
        <div style="margin-top:6px;">
          <button onclick="uiLogout()">Kijelentkez√©s</button>
        </div>
      </div>
    </div>
  </div>

  <!-- MAIN ADMIN PANEL -->
  <div id="adminPanel" style="display:none;margin-top:12px;">
    <div class="row">
      <!-- Tournaments -->
      <div class="col box">
        <h2>Torn√°k</h2>
        <div class="row">
          <input id="newTournamentName" placeholder="Torna neve">
          <button onclick="createTournament()">Torna l√©trehoz√°sa</button>
        </div>
        <div id="tournamentList"></div>
      </div>

      <!-- Teams -->
      <div class="col box">
        <h2>Csapatok</h2>
        <div class="row">
          <input id="newTeamName" placeholder="Csapat neve">
          <button onclick="addTeam()">Csapat hozz√°ad√°sa</button>
        </div>
        <div id="teamList" style="max-height:260px;overflow:auto"></div>
      </div>
    </div>

    <!-- Groups -->
    <div class="row">
      <div class="col box">
        <h2>Csoportok</h2>
        <div class="row">
          <input id="teamsPerGroup" class="small" placeholder="Csapat / csoport" type="number" min="2">
          <button onclick="autoCreateGroups()">Automatikus sorol√°s</button>
          <button onclick="addGroupUI()">‚ûï √öj csoport</button>
          <button onclick="saveDB()">Ment√©s</button>
        </div>
        <div id="groupsArea"></div>
        <div style="margin-top:8px;color:#666;font-size:13px">K√©zi sorsol√°sn√°l haszn√°ld az "√Åthelyez" √©s "T√∂r√∂l" gombokat.</div>
      </div>

      <!-- Matches & scheduling -->
      <div class="col box">
        <h2>M√©rk≈ëz√©sek (csoportk√∂r)</h2>
        <div style="margin-bottom:8px;">
          <button onclick="regenerateMatches()">Meccsek gener√°l√°sa automatikusan</button>
          <button onclick="saveDB()">Ment√©s</button>
        </div>
        <div id="matchesArea" style="max-height:420px;overflow:auto"></div>
      </div>
    </div>

    <!-- Knockout -->
    <div class="row">
      <div class="col box">
        <h2>Kies√©ses szakasz</h2>
        <div class="row">
          <input id="advanceCount" class="small" placeholder="H√°ny jut tov√°bb" type="number" min="1">
          <button onclick="autoKnockout()">Automatikus tov√°bbjut√≥k + sorsol√°s</button>
          <button onclick="manualKnockoutUI()">K√©zi p√°ros√≠t√°s</button>
          <button onclick="saveDB()">Ment√©s</button>
        </div>
        <div id="knockoutArea"></div>
      </div>

      <div class="col box">
        <h2>Dobog√≥</h2>
        <div id="podiumArea"></div>
        <div style="margin-top:8px;">
          <button onclick="computePodium()">Dobog√≥ kisz√°mol√°sa (egyszer≈±)</button>
        </div>
      </div>
    </div>

  </div>
</div>

<script>
/* -----------------------
   ADATMODELL (localStorage)
   ----------------------- */
const STORAGE_KEY = "tournamentDB_v1";

function loadDB(){
  let raw = localStorage.getItem(STORAGE_KEY);
  if(!raw){ 
    const initial = { users:[], loggedIn:null, tournaments:[] };
    localStorage.setItem(STORAGE_KEY, JSON.stringify(initial));
    return initial;
  }
  try{ return JSON.parse(raw); }catch(e){ const initial={ users:[], loggedIn:null, tournaments:[]}; localStorage.setItem(STORAGE_KEY, JSON.stringify(initial)); return initial;}
}
function saveDB(){
  localStorage.setItem(STORAGE_KEY, JSON.stringify(DB));
  // storage event will fire in other tabs - viewers can listen and refresh UI
}
let DB = loadDB();

/* -----------------------
   AUTH (simple local)
   ----------------------- */
function uiRegister(){
  const u = document.getElementById("regUser").value.trim();
  const p = document.getElementById("regPass").value;
  if(!u||!p){ alert("Adj felhaszn√°l√≥nevet √©s jelsz√≥t"); return; }
  if(DB.users.find(x=>x.user===u)){ alert("L√©tezik ilyen felhaszn√°l√≥"); return; }
  DB.users.push({ user:u, pass:p });
  DB.loggedIn = u;
  saveDB(); refreshAuthUI();
  alert("Regisztr√°ci√≥ k√©sz √©s bejelentkezve: " + u);
}
function uiLogin(){
  const u = document.getElementById("logUser").value.trim();
  const p = document.getElementById("logPass").value;
  if(!u||!p){ alert("Adj felhaszn√°l√≥nevet √©s jelsz√≥t"); return; }
  const user = DB.users.find(x=>x.user===u && x.pass===p);
  if(!user){ alert("Hib√°s adatok"); return; }
  DB.loggedIn = u; saveDB(); refreshAuthUI();
}
function uiLogout(){
  DB.loggedIn = null; saveDB(); refreshAuthUI();
}
function refreshAuthUI(){
  document.getElementById("who").innerText = DB.loggedIn ? ("Bejelentkezve: "+DB.loggedIn) : "Nincs bejelentkezve";
  document.getElementById("adminPanel").style.display = DB.loggedIn ? "block" : "none";
  if(DB.loggedIn){
    renderTournamentList();
    renderAllUI();
  }
}
refreshAuthUI();

/* -----------------------
   TORN√ÅK
   ----------------------- */
function createTournament(){
  const name = document.getElementById("newTournamentName").value.trim();
  if(!name){ alert("Adj tornanevet"); return; }
  const t = { id: Date.now(), name, teams:[], groups: {}, matches: [], knockout: [], podium: [] };
  DB.tournaments.push(t); saveDB(); renderTournamentList(); selectTournament(t.id);
}
function renderTournamentList(){
  const el = document.getElementById("tournamentList"); el.innerHTML = "";
  DB.tournaments.forEach(t=>{
    const d=document.createElement("div");
    d.className="groupBox";
    d.innerHTML = `<b>${t.name}</b> 
      <div style="margin-top:6px;">
        <button onclick="selectTournament(${t.id})">Megnyit</button>
        <button onclick="deleteTournament(${t.id})">T√∂rl√©s</button>
      </div>`;
    el.appendChild(d);
  });
}
function deleteTournament(id){
  if(!confirm("Biztos t√∂r√∂lni akarod a torn√°t?")) return;
  DB.tournaments = DB.tournaments.filter(x=>x.id!==id);
  saveDB(); renderTournamentList(); clearActive();
}
function selectTournament(id){
  activeTournamentId = id;
  renderAllUI();
}

/* -----------------------
   UTILS
   ----------------------- */
let activeTournamentId = null;
function getActiveTournament(){
  if(!activeTournamentId){
    // if none selected, try first
    if(DB.tournaments.length) { activeTournamentId = DB.tournaments[0].id; }
    else return null;
  }
  return DB.tournaments.find(x=>x.id===activeTournamentId);
}
function clearActive(){ activeTournamentId=null; renderAllUI(); }

/* -----------------------
   CSAPATOK
   ----------------------- */
function addTeam(){
  const t = getActiveTournament();
  if(!t){ alert("Nincs kiv√°lasztott torna"); return; }
  const name = document.getElementById("newTeamName").value.trim();
  if(!name) return alert("Adj csapatnevet!");
  if(t.teams.includes(name)) return alert("Ez a csapat m√°r fel van v√©ve!");
  t.teams.push(name);
  saveDB(); renderTeamList(); renderGroupsArea();
}
function removeTeam(name){
  const t = getActiveTournament();
  if(!t) return;
  if(!confirm("T√©nyleg t√∂rl√∂d a csapatot? "+name)) return;
  // remove from teams and groups and matches
  t.teams = t.teams.filter(x=>x!==name);
  for(let g in t.groups) t.groups[g] = t.groups[g].filter(x=>x!==name);
  t.matches = t.matches.filter(m=>m.home!==name && m.away!==name);
  saveDB(); renderTeamList(); renderGroupsArea(); renderMatches();
}
function renderTeamList(){
  const t = getActiveTournament();
  const el = document.getElementById("teamList"); el.innerHTML = "";
  if(!t) { el.innerHTML = "<i>Nincs torna kiv√°lasztva</i>"; return; }
  t.teams.forEach(team=>{
    const div = document.createElement("div");
    div.className="teamItem";
    div.innerHTML = `<div>${team}</div>
      <div>
        <button onclick="promptMoveTeam('${team}')">√Åthelyez</button>
        <button onclick="removeTeam('${team}')">T√∂r√∂l</button>
      </div>`;
    el.appendChild(div);
  });
}
function promptMoveTeam(team){
  const t = getActiveTournament();
  if(!t) return;
  const groups = Object.keys(t.groups);
  if(groups.length<1) return alert("Nincsen csoport. Hozz l√©tre el≈ëbb.");
  const target = prompt("Melyik csoportba helyezzem √°t? (pontosan a n√©v)", groups.join(", "));
  if(!target) return;
  // remove from any group
  for(let g in t.groups) t.groups[g] = t.groups[g].filter(x=>x!==team);
  // add to target (create if not exist)
  if(!t.groups[target]) t.groups[target]=[];
  t.groups[target].push(team);
  saveDB(); renderAllUI();
}

/* -----------------------
   CSOPORTOK
   ----------------------- */
function addGroupUI(){
  const t = getActiveTournament();
  if(!t) return alert("V√°lassz torn√°t");
  let i = Object.keys(t.groups).length+1;
  let name = "Csoport "+i;
  // ensure unique
  while(t.groups[name]) { i++; name = "Csoport "+i; }
  t.groups[name]=[];
  saveDB(); renderGroupsArea(); renderManualGroups(); 
}
function autoCreateGroups(){
  const t = getActiveTournament();
  if(!t) return alert("V√°lassz torn√°t");
  const per = Number(document.getElementById("teamsPerGroup").value);
  if(!per || per<2) return alert("Adj meg √©rv√©nyes csapatsz√°mot per csoport (>=2)");
  // shuffle
  const shuffled = [...t.teams].sort(()=>Math.random()-0.5);
  t.groups = {};
  let idx=0, gnum=1;
  while(idx < shuffled.length){
    t.groups["Csoport "+gnum] = shuffled.slice(idx, idx+per);
    idx += per;
    gnum++;
  }
  // if last group too small (1) then merge with previous
  const keys = Object.keys(t.groups);
  if(keys.length>1){
    const lastKey = keys[keys.length-1];
    if(t.groups[lastKey].length < Math.ceil(per/2)){
      const prevKey = keys[keys.length-2];
      t.groups[prevKey] = t.groups[prevKey].concat(t.groups[lastKey]);
      delete t.groups[lastKey];
    }
  }
  generateGroupMatches(); saveDB(); renderAllUI();
}

function renderGroupsArea(){
  const t = getActiveTournament();
  const el = document.getElementById("groupsArea");
  el.innerHTML = "";
  if(!t) return el.innerHTML = "<i>V√°lassz torn√°t</i>";
  for(let g in t.groups){
    const div = document.createElement("div");
    div.className="groupBox";
    let html = `<b>${g}</b><div style="margin-top:6px">`;
    t.groups[g].forEach(team => {
      html += `<div style="display:flex;justify-content:space-between;align-items:center;padding:4px 0">
                 <div>${team}</div>
                 <div>
                   <select id="sel_${g}_${team}">${Object.keys(t.groups).filter(x=>x!==g).map(x=>`<option>${x}</option>`).join("")}</select>
                   <button onclick="moveTeam('${g}',document.getElementById('sel_${g}_${team}').value,'${team}')">√Åthelyez</button>
                   <button onclick="removeFromGroup('${g}','${team}')">T√∂r√∂l</button>
                 </div>
               </div>`;
    });
    html += `</div>`;
    div.innerHTML = html;
    el.appendChild(div);
  }
}
function moveTeam(fromG,toG,team){
  const t = getActiveTournament();
  if(!t) return;
  // remove from source
  t.groups[fromG] = t.groups[fromG].filter(x=>x!==team);
  if(!t.groups[toG]) t.groups[toG]=[];
  if(!t.groups[toG].includes(team)) t.groups[toG].push(team);
  saveDB(); renderGroupsArea(); generateGroupMatches(); renderMatches();
}
function removeFromGroup(g,team){
  const t = getActiveTournament();
  if(!t) return;
  if(!confirm("T√©nyleg t√∂rl√∂d a csapatot a csoportb√≥l?")) return;
  t.groups[g] = t.groups[g].filter(x=>x!==team);
  saveDB(); renderGroupsArea(); generateGroupMatches(); renderMatches();
}

/* -----------------------
   M√âRK≈êZ√âSEK (csoportk√∂r)
   ----------------------- */
function regenerateMatches(){
  generateGroupMatches();
  saveDB(); renderMatches();
}
function generateGroupMatches(){
  const t = getActiveTournament();
  if(!t) return;
  t.matches = [];
  for(let g in t.groups){
    const arr = t.groups[g];
    for(let i=0;i<arr.length;i++){
      for(let j=i+1;j<arr.length;j++){
        t.matches.push({ id:Date.now()+Math.random(), group:g, home:arr[i], away:arr[j], datetime:"", homeScore:null, awayScore:null, order:t.matches.length });
      }
    }
  }
  // ensure stable order
  t.matches.sort((a,b)=>a.order - b.order);
  saveDB();
}
function renderMatches(){
  const t = getActiveTournament();
  const el = document.getElementById("matchesArea");
  el.innerHTML = "";
  if(!t) return;
  // sort by order
  t.matches.sort((a,b)=> (a.order||0) - (b.order||0) );
  t.matches.forEach((m, idx)=>{
    const div = document.createElement("div");
    div.className="matchRow";
    div.innerHTML = `
      <div style="flex:1"><b>${m.group}</b> ‚Äî ${m.home} vs ${m.away}</div>
      <div>Id≈ëpont: <input value="${m.datetime||''}" onchange="setMatchDate(${idx}, this.value)" placeholder="YYYY-MM-DD HH:MM"></div>
      <div>
        Eredm√©ny: 
        <input size="3" value="${m.homeScore!=null?m.homeScore:''}" onchange="setMatchScore(${idx}, 'home', this.value)">
        :
        <input size="3" value="${m.awayScore!=null?m.awayScore:''}" onchange="setMatchScore(${idx}, 'away', this.value)">
      </div>
      <div>
        <button onclick="moveMatchUp(${idx})">‚ñ≤</button>
        <button onclick="moveMatchDown(${idx})">‚ñº</button>
        <button onclick="deleteMatch(${idx})">T√∂r√∂l</button>
      </div>
    `;
    el.appendChild(div);
  });
}
function setMatchDate(i,val){
  const t = getActiveTournament(); if(!t) return;
  t.matches[i].datetime = val;
  saveDB(); // notify viewers via storage event
}
function setMatchScore(i, side, val){
  const t = getActiveTournament(); if(!t) return;
  if(val === "") { if(side==='home') t.matches[i].homeScore = null; else t.matches[i].awayScore = null; }
  else { if(side==='home') t.matches[i].homeScore = Number(val); else t.matches[i].awayScore = Number(val); }
  saveDB();
}
function moveMatchUp(i){
  const t = getActiveTournament(); if(!t||i<=0) return;
  const tmp = t.matches[i-1].order; t.matches[i-1].order = t.matches[i].order; t.matches[i].order = tmp;
  saveDB(); renderMatches();
}
function moveMatchDown(i){
  const t = getActiveTournament(); if(!t||i>=t.matches.length-1) return;
  const tmp = t.matches[i+1].order; t.matches[i+1].order = t.matches[i].order; t.matches[i].order = tmp;
  saveDB(); renderMatches();
}
function deleteMatch(i){
  const t = getActiveTournament(); if(!t) return;
  if(!confirm("T√©nyleg t√∂r√∂lni szeretn√©d a m√©rk≈ëz√©st?")) return;
  t.matches.splice(i,1); saveDB(); renderMatches();
}

/* -----------------------
   KIES√âSES (automata & k√©zi)
   ----------------------- */
function autoKnockout(){
  const t = getActiveTournament(); if(!t) return;
  const adv = Number(document.getElementById("advanceCount").value);
  if(!adv) return alert("Add meg, h√°ny jut tov√°bb csoportonk√©nt");
  // compute standings per group
  let qualified = [];
  for(let g in t.groups){
    // compute points
    const pts = {};
    t.groups[g].forEach(tm=>pts[tm]=0);
    t.matches.filter(m=>m.group===g).forEach(m=>{
      if(m.homeScore!=null && m.awayScore!=null){
        if(m.homeScore > m.awayScore) pts[m.home]+=3;
        else if(m.homeScore < m.awayScore) pts[m.away]+=3;
        else { pts[m.home] += 1; pts[m.away] += 1; }
      }
    });
    // sort by points
    const sorted = Object.keys(pts).sort((a,b)=>pts[b]-pts[a]);
    qualified.push(...sorted.slice(0,adv));
  }
  // simple pairing (first vs last etc.)
  t.knockout = [];
  while(qualified.length >= 2){
    const a = qualified.shift();
    const b = qualified.pop();
    t.knockout.push({ home:a, away:b, homeScore:null, awayScore:null });
  }
  saveDB(); renderKnockoutArea();
}
function manualKnockoutUI(){
  const t = getActiveTournament(); if(!t) return alert("Nincs torna");
  const area = document.getElementById("knockoutArea"); area.innerHTML = "";
  // list qualified candidates from last computed or allow picking
  // We'll list all teams and let admin pick pairs
  let html = `<div style="margin-bottom:8px;"><b>K√©zi p√°ros√≠t√°s</b></div>`;
  html += `<div id="manualPairs"></div>`;
  html += `<div style="margin-top:8px;"><button onclick="saveManualPairs()">P√°ros√≠t√°sok ment√©se</button></div>`;
  area.innerHTML = html;
  // create selectors for pairs - allow admin to choose any team per slot
  const manualPairs = document.getElementById("manualPairs");
  manualPairs.innerHTML = "";
  // default create N pairs for possible max teams
  const teams = [...t.teams];
  const maxPairs = Math.floor(teams.length/2);
  for(let i=0;i<maxPairs;i++){
    const div = document.createElement("div");
    const selA = document.createElement("select");
    const selB = document.createElement("select");
    [selA,selB].forEach(s=>{
      teams.forEach(tm=>{ const o=document.createElement("option"); o.value=tm; o.textContent=tm; s.appendChild(o); });
    });
    div.appendChild(document.createTextNode("A: ")); div.appendChild(selA);
    div.appendChild(document.createTextNode("  B: ")); div.appendChild(selB);
    div.style.marginBottom="6px";
    manualPairs.appendChild(div);
  }
}
function saveManualPairs(){
  const t = getActiveTournament(); if(!t) return;
  const manualPairs = document.getElementById("manualPairs");
  const selects = manualPairs.querySelectorAll("select");
  const pairs = [];
  for(let i=0;i<selects.length;i+=2){
    const a = selects[i].value;
    const b = selects[i+1].value;
    if(a && b && a!==b) pairs.push({ home:a, away:b, homeScore:null, awayScore:null });
  }
  t.knockout = pairs;
  saveDB(); renderKnockoutArea();
}

function renderKnockoutArea(){
  const t = getActiveTournament();
  const area = document.getElementById("knockoutArea"); area.innerHTML = "";
  if(!t || !t.knockout || !t.knockout.length) return area.innerHTML = "<i>Nincs kies√©ses p√°ros√≠t√°s</i>";
  t.knockout.forEach((m,i)=>{
    const div = document.createElement("div");
    div.className="matchRow";
    div.innerHTML = `<div style="flex:1">${m.home} vs ${m.away}</div>
      <div>
        <input value="${m.homeScore!=null?m.homeScore:''}" onchange="setKnockScore(${i},'home',this.value)" size="3"> :
        <input value="${m.awayScore!=null?m.awayScore:''}" onchange="setKnockScore(${i},'away',this.value)" size="3">
      </div>`;
    area.appendChild(div);
  });
}
function setKnockScore(i,side,val){
  const t = getActiveTournament(); if(!t) return;
  if(side==='home') t.knockout[i].homeScore = val==="" ? null : Number(val);
  else t.knockout[i].awayScore = val==="" ? null : Number(val);
  saveDB();
}

/* -----------------------
   DOB√ìG√ì (egyszer≈±)
   ----------------------- */
function computePodium(){
  const t = getActiveTournament(); if(!t) return;
  // simple: if knockout last match contains scores -> decide winner
  if(!t.knockout || t.knockout.length===0) return alert("Nincs kies√©ses meccs");
  const final = t.knockout[t.knockout.length-1];
  if(final.homeScore==null || final.awayScore==null) return alert("T√∂ltsd ki a d√∂nt≈ë eredm√©ny√©t");
  const champ = final.homeScore > final.awayScore ? final.home : final.away;
  const second = champ===final.home ? final.away : final.home;
  t.podium = [champ, second, "3. hely - nincs kisorsolva"];
  saveDB();
  document.getElementById("podiumArea").innerHTML = `ü•á ${t.podium[0]}<br>ü•à ${t.podium[1]}<br>ü•â ${t.podium[2]}`;
}

/* -----------------------
   GLOBAL RENDER
   ----------------------- */
function renderAllUI(){
  renderTournamentList();
  renderTeamList();
  renderGroupsArea();
  renderManualGroups();
  renderMatches();
  renderKnockoutArea();
  const t = getActiveTournament();
  document.getElementById("podiumArea").innerHTML = t && t.podium ? (`ü•á ${t.podium[0]||''}<br>ü•à ${t.podium[1]||''}<br>ü•â ${t.podium[2]||''}`) : "";
}

/* -----------------------
   Init: if user logged in, show UI
   ----------------------- */
(function init(){
  DB = loadDB();
  if(DB.loggedIn) { activeTournamentId = DB.tournaments.length ? DB.tournaments[0].id : null; renderAllUI(); }
})();

/* -----------------------
   Listen storage event so multiple tabs (admin & viewer) can update
   ----------------------- */
window.addEventListener("storage", (e)=>{
  if(e.key === STORAGE_KEY){
    DB = loadDB();
    renderAllUI();
  }
});
</script>
</body>
</html>
